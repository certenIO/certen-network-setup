services:
  postgres:
    image: postgres:15-alpine
    container_name: certen-postgres
    environment:
      POSTGRES_DB: certen
      POSTGRES_USER: certen
      POSTGRES_PASSWORD: certen_testnet_2026
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./validator-build/pkg/database/migrations/001_initial_schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U certen -d certen"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  validator-1:
    build: ./validator-build
    container_name: certen-validator-1
    ports:
      - "8081:8080"
      - "26656:26656"
      - "26657:26657"
    environment:
      VALIDATOR_ID: validator-1
      DATABASE_URL: postgres://certen:certen_testnet_2026@postgres:5432/certen?sslmode=disable
      COMETBFT_ENABLED: "true"
      COMETBFT_MODE: validator
      COMETBFT_CHAIN_ID: certen-testnet
      # Kermit Accumulate Network Endpoints
      ACCUMULATE_URL: http://206.191.154.164:8660
      ACCUMULATE_COMET_DN: http://206.191.154.164:8660
      ACCUMULATE_COMET_BVN: http://206.191.154.164:8760
      ACCUMULATE_COMET_BVN0: http://206.191.154.164:8760
      ACCUMULATE_COMET_BVN1: http://206.191.154.164:8860
      ACCUMULATE_COMET_BVN2: http://206.191.154.164:8960
      # Ethereum (Sepolia testnet)
      ETHEREUM_URL: https://eth-sepolia.g.alchemy.com/v2/demo
      ETH_CHAIN_ID: "11155111"
      ETH_PRIVATE_KEY: "0x1111111111111111111111111111111111111111111111111111111111111111"
      CERTEN_CONTRACT_ADDRESS: "0xEb17eBd351D2e040a0cB3026a3D04BEc182d8b98"
      # Attestation
      ATTESTATION_PEERS: http://validator-2:8080,http://validator-3:8080
      ATTESTATION_REQUIRED_COUNT: "2"
      BLS_ZK_TESTING_MODE: "true"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  validator-2:
    build: ./validator-build
    container_name: certen-validator-2
    ports:
      - "8082:8080"
      - "26666:26656"
    environment:
      VALIDATOR_ID: validator-2
      DATABASE_URL: postgres://certen:certen_testnet_2026@postgres:5432/certen?sslmode=disable
      COMETBFT_ENABLED: "true"
      COMETBFT_MODE: validator
      COMETBFT_CHAIN_ID: certen-testnet
      # Kermit Accumulate Network Endpoints
      ACCUMULATE_URL: http://206.191.154.164:8660
      ACCUMULATE_COMET_DN: http://206.191.154.164:8660
      ACCUMULATE_COMET_BVN: http://206.191.154.164:8760
      ACCUMULATE_COMET_BVN0: http://206.191.154.164:8760
      ACCUMULATE_COMET_BVN1: http://206.191.154.164:8860
      ACCUMULATE_COMET_BVN2: http://206.191.154.164:8960
      # Ethereum (Sepolia testnet)
      ETHEREUM_URL: https://eth-sepolia.g.alchemy.com/v2/demo
      ETH_CHAIN_ID: "11155111"
      ETH_PRIVATE_KEY: "0x2222222222222222222222222222222222222222222222222222222222222222"
      CERTEN_CONTRACT_ADDRESS: "0xEb17eBd351D2e040a0cB3026a3D04BEc182d8b98"
      # Attestation
      ATTESTATION_PEERS: http://validator-1:8080,http://validator-3:8080
      ATTESTATION_REQUIRED_COUNT: "2"
      BLS_ZK_TESTING_MODE: "true"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  validator-3:
    build: ./validator-build
    container_name: certen-validator-3
    ports:
      - "8083:8080"
      - "26676:26656"
    environment:
      VALIDATOR_ID: validator-3
      DATABASE_URL: postgres://certen:certen_testnet_2026@postgres:5432/certen?sslmode=disable
      COMETBFT_ENABLED: "true"
      COMETBFT_MODE: validator
      COMETBFT_CHAIN_ID: certen-testnet
      # Kermit Accumulate Network Endpoints
      ACCUMULATE_URL: http://206.191.154.164:8660
      ACCUMULATE_COMET_DN: http://206.191.154.164:8660
      ACCUMULATE_COMET_BVN: http://206.191.154.164:8760
      ACCUMULATE_COMET_BVN0: http://206.191.154.164:8760
      ACCUMULATE_COMET_BVN1: http://206.191.154.164:8860
      ACCUMULATE_COMET_BVN2: http://206.191.154.164:8960
      # Ethereum (Sepolia testnet)
      ETHEREUM_URL: https://eth-sepolia.g.alchemy.com/v2/demo
      ETH_CHAIN_ID: "11155111"
      ETH_PRIVATE_KEY: "0x3333333333333333333333333333333333333333333333333333333333333333"
      CERTEN_CONTRACT_ADDRESS: "0xEb17eBd351D2e040a0cB3026a3D04BEc182d8b98"
      # Attestation
      ATTESTATION_PEERS: http://validator-1:8080,http://validator-2:8080
      ATTESTATION_REQUIRED_COUNT: "2"
      BLS_ZK_TESTING_MODE: "true"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:
